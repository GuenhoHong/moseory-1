<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="product">

	<!-- 상품정보 등록 -->
	<insert id="regist" parameterType="productVO">
		INSERT INTO tbl_product
			(code, name, high_code, low_code, price, sale_count, grade, wish_count, file_path, file_name, product_comment) 
		VALUES(
			seq_product_code.nextval,
			#{name},
			#{high_code},
			#{low_code},
			#{price},
			0, <!-- sale_count -->
			0, <!-- grade -->
			0,<!-- wish_count -->
			#{file_path},
			#{file_name},
			#{product_comment}
		)
	</insert>
	
	<!-- 상품코드 조회 -->
	<select id="setCode" parameterType="String" resultType="int">
		select code from tbl_product
			where name = #{name}
	</select>
	
	<!-- 상품디테일 등록 -->
	<insert id="product_detail_regist" parameterType="productdetailVO">
		insert into tbl_product_detail values(
			seq_product_detail_no.nextval,
			seq_product_code.currval,
			#{product_color},
			#{product_size},
			#{product_stock}
		)
	</insert>
	
	<!-- 상위카테고리 상품리스트 -->
	<select id="highCateList" parameterType="int" resultType = "productVO">
		select * from tbl_product
			where high_code = #{high_code}
	</select>
	
	<!--상품 코드로 정보 조회 -->
	<select id="getView" parameterType="int" resultType = "productVO">
	SELECT
		code, name, high_code, low_code, price, sale_count, grade, wish_count, file_path, file_name, product_comment
	FROM
		tbl_product
	WHERE
		code = #{code}
	</select>
	
	<!-- 상품 코드로 디테일 정보 조회 -->
	<select id="getDetailView" parameterType="int" resultType = "productdetailVO">
	SELECT
		no, product_code, product_color, product_size, product_stock
	FROM
		tbl_product_detail
	WHERE
		product_code = #{product_code}
	</select>
	
	<!-- 해당 상품의 색상을 중복 없이 조회 -->
	<select id="getProductColor" resultType="String">
	SELECT
		distinct product_color 
	FROM
		tbl_product_detail 
	WHERE
		product_code = #{product_code}
	</select>
	
	<!-- 해당 상품 색상의 사이즈를 조회 -->
	<select id="getProductSize" resultType="productdetailVO">
	SELECT
		no, product_code, product_color, product_size, product_stock
	FROM
		tbl_product_detail
	WHERE
		product_code = #{product_code} 
		<if test="product_color != null">
			AND product_color = #{product_color}
		</if>
		<if test="product_color == null">
			AND product_color is null
		</if>
	</select>
	
	<!-- 해당 정보의 상품 디테일 번호 조회 -->
	<select id="getProductDetailNo" resultType="int">
	SELECT
		no
	FROM
		tbl_product_detail
	WHERE
		product_code = #{product_code}
		<if test="product_color != null">
			AND product_color = #{product_color}
		</if>
		<if test="product_color == null">
			AND product_color is null
		</if>
		<if test="product_size != null">
			AND product_size = #{product_size}
		</if>
		<if test="product_size == null">
			AND product_size is null
		</if>
	</select>
	
	<!-- 해당 상품의 리뷰 개수 조회 -->
	<select id="getReviewCount" resultType="int">
	SELECT
    	count(*)
	FROM
	    tbl_review r left outer join tbl_product_detail pd on r.product_detail_no = pd.no
	WHERE 
	    product_code = #{product_code}
	</select>
	
	<!-- 해당 상품의 문의글 개수 조회 -->
	<select id="getQnaCount" resultType="int">
	SELECT
	    count(*)
	FROM
	    tbl_qna
	WHERE 
	    product_code = #{product_code}
	</select>
	
	<resultMap type="ReviewVO" id="reviewMap">
		<result column="no" property="no" />
		<result column="title" property="title" />
		<result column="content" property="content" />
		<result column="reg_date" property="reg_date" />
		<result column="hit" property="hit" />
		<result column="file_path" property="file_path" />
		<result column="file_name" property="file_name" />
		<result column="recommend" property="recommend" />
		<result column="grade" property="grade" />
		<association property="member" javaType="MemberVO">
			<result column="id" property="id" />
			<result column="lev" property="level" typeHandler="LevelEnumTypeHandler" />
		</association>
		<association property="product_detail" javaType="productdetailVO">
			<result column="product_detail_no" property="no" />
			<result column="product_code" property="product_code" />
			<result column="product_color" property="product_color" />
			<result column="product_size" property="product_size" />
		</association>
	</resultMap>
	
	<!-- 상품 정보 페이지의 리뷰 조회 -->
	<select id="getReview" resultMap="reviewMap">
	<![CDATA[
	SELECT 
	    rownum, r.no, m.id, m.lev, r.title, r.content, r.reg_date, r.hit, r.file_path, r.file_name, r.recommend, r.grade,
	    pd.no as product_detail_no, pd.product_code, pd.product_color, pd.product_size
	FROM
	    tbl_member m, 
	    (SELECT 
	        rownum, no, member_id, title, content, reg_date, hit, file_path, file_name, product_detail_no, recommend, grade 
	     FROM
	        tbl_review
	     ORDER BY
	]]>
	        <choose>
				<when test="type == 'N'.toString()">
					no desc
				</when>
				<when test="type == 'R'.toString()">
					recommend desc
				</when>
				<when test="type == 'H'.toString()">
					grade desc
				</when>
				<when test="type == 'L'.toString()">
					grade asc
				</when>
			</choose>
	<![CDATA[
	     ) r, tbl_product_detail pd
	WHERE
	    r.product_detail_no = pd.no 
	    AND m.id = r.member_id
	    AND pd.product_code = #{product_code}
	    AND rownum <= #{limit}
	]]>
	</select>
	
	<!-- 추천 수 불러올 때 사용 -->
	<select id="getOriginalReview" resultMap="reviewMap">
	SELECT
		*
	FROM
		tbl_review
	WHERE
		no = #{no}
	</select>
	
	<!-- 추천수 증가 -->
	<update id="increaseRecommend">
	UPDATE 
    	tbl_review 
	SET 
	    recommend = recommend + 1
	WHERE
	    no = #{no}
	</update>
	
	<!-- 추천수 감소 -->
	<update id="decreaseRecommend">
	UPDATE 
    	tbl_review 
	SET 
	    recommend = recommend - 1
	WHERE
	    no = #{no}
	</update>
	
	<resultMap type="QnAVO" id="QnAMap">
		<result column="no" property="no" />
		<result column="product_code" property="product_code" />
		<result column="title" property="title" />
		<result column="content" property="content" />
		<result column="reg_date" property="reg_date" />
		<result column="hit" property="hit" />
		<association property="member" javaType="MemberVO">
			<result column="id" property="id" />
			<result column="name" property="name" />
		</association>
	</resultMap>
	
	<!-- 상품 정보 페이지의 Q&A 조회 -->
	<select id="getQnA" resultMap="QnAMap">
	SELECT
	    q.no, m.id, m.name, q.product_code, q.title, q.content, q.reg_date, q.hit
	FROM
	    tbl_qna q LEFT OUTER JOIN tbl_member m ON q.member_id = m.id
	WHERE
		product_code = #{product_code}
	ORDER BY
		q.no desc
	</select>
	

	
</mapper>







